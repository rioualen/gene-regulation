import os

## Use the default Snakefile unless a specific snakefile is defined in the config file.
if not "files" in config.keys():
    config["files"] = {}

if not "snakefile" in config["files"].keys():
    config["files"]["snakefile"] = workflow.snakefile;

## The verbosity MUST be set to zero for the flowcharts
from snakemake.utils import read_job_properties

rule flowcharts:
    """Draw flowcharts for the current snakefile: dag and rulegraph.

    Requires to specify the following entries in the config
    dictionary.

    config["reports"]["dag"]
    config["reports"]["rulegraph"]
    config["dir"]["reports"]

    We have to specify the snakefile that we want to use

    config["files"]["snakefile"]

    Usage example:
    	expand(config["dir"]["reports"] + "dag.pdf") 

    # TODO allow user to chose between vertical or horizontal graphs, depending on the nulber of samples...

    """
    output: dag_dot = config["reports"]["dag"] + ".dot", \
            dag_png = config["reports"]["dag"] + ".png", \
            dag_pdf = config["reports"]["dag"] + ".pdf", \
            rulegraph_dot = config["reports"]["rulegraph"] + ".dot", \
            rulegraph_pdf = config["reports"]["rulegraph"] + ".pdf", \
            rulegraph_png = config["reports"]["rulegraph"] + ".png"
    params: scripts = config["files"]["snakefile"]
    log: config["dir"]["reports"] + "flow.log"
    shell: """
(snakemake  --config verbosity=0 -s {params.scripts} --dag | perl -pe 's/graph\[/graph\[rankdir='LR', /' > {output.dag_dot}
dot -Tpng -o {output.dag_png} {output.dag_dot}
dot -Tpdf -o {output.dag_pdf} {output.dag_dot}
snakemake --config verbosity=0  -s {params.scripts} --rulegraph >  {output.rulegraph_dot}
dot -Tpng -o {output.rulegraph_png}  {output.rulegraph_dot}
dot -Tpdf -o {output.rulegraph_pdf}  {output.rulegraph_dot}) &> {log}
"""



#          + "; Snakemake  --config verbosity=0 -s {params.scripts} --dag  | perl -pe 's/graph\[/graph\[rankdir='LR', /' | dot -Tpng -o {output.dag_png} "
    


#rule viz:
#    input:
#        expand("viz/{graph}.{fmt}", graph=["rulegraph", "dag"], fmt=["pdf", "png"])

#rule graph:
#    output:
#        "viz/{graph,(dag|rulegraph)}.dot"
#    shell:
#        "snakemake --{wildcards.graph} > {output}"


#rule render_dot:
#    input:
#        "{prefix}.dot"
#    output:
#        "{prefix}.{fmt,(png|pdf)}"
#    shell:
#        "dot -T{wildcards.fmt} < {input} > {output}"
