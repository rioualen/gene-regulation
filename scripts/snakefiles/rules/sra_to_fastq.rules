rule import_sra_to_fastq:
	"""Converts SRA files in fastq format with SRA toolkit. 
	
	TODO locally in workflow: 
		- import/merging local rule before conversion, as the output is in working dir by default (or consider including --outdir option)
		- rename files to sample name even if no merging (input & output files have the same name though sample & raw file can have different names eg. GSM vs SRR)
	
	Parameters required:
		config['qsub']
		config['dir']['results']
		config['dir']['reads_source']
	Usage:
		SRA_TO_FASTQ = expand(config['dir']['results'] + "{dataset}/{file}.fastq", dataset=DATASETS, file=FILES)
	"""
	input:	datadir = config['dir']['reads_source']
	output: fastq = "{results}/{sample}/{sample}.fastq"
	log: "{results}/{sample}/{sample}_sra-conversion.log"
	benchmark: "{results}/{sample}/{sample}_sra-conversion_benchmark.json"
	params: qsub = config["qsub"] + " -q short -e {sample}_sra-conversion_qsub.err -o {sample}_sra-conversion_qsub.out",  \
		results = config['dir']['results'], \
		samples = "{sample}"
	shell:"""
(echo "SHELL: $SHELL"
samples={params.samples}
for sam in ${{samples[@]}}
do
	mkdir -p {params.results}$sam
	echo -e "Reading $sam directory {input.datadir}$sam... \n"
	files=({input.datadir}$sam/*)
	if [ ${{#files[@]}} -gt 1 ]
	then
		echo -e " \n \nCase 2+ files : ${{files[@]}} \n"
		for f in ${{files[@]}}
		do
			base=$(basename $f .sra)
			echo -e "$base \n"
			echo -e " \tConverting $base.sra to $base.fastq... \n"
			fastq-dump --outdir {params.results}$sam/ {input.datadir}$sam/$base.sra
		done
		echo -e " \tMerging ${{#files[@]}} together as $sam.fastq. \n"
		echo -e " \tCmd: cat ${{files[@]}} > {input.datadir}$sam.fastq"
		files=({params.results}$sam/*)
		cat ${{files[@]}} > {params.results}$sam/$sam.fastq
		rm ${{files[@]}}
	else
		echo -e " \n \nCase 1 file : ${{files[@]}} \n"
		base=$(basename ${{files[0]}} .sra)
		echo -e " \tConverting $base.sra to $base.fastq... \n"
		fastq-dump --outdir {params.results}$sam {input.datadir}$sam/$base.sra
		echo -e " \tMoving {input.datadir}$base.fastq to {params.results}$sam/$sam.fastq \n"
		mv  {params.results}$sam/$base.fastq {params.results}$sam/$sam.fastq
	fi
done
echo "Job done.") &> {log}
"""


#		if [ ! -d {params.results} ] \
#		then \
#		mkdir {params.results} \
#		fi \
#		samples=$(ls {input.datadir}) \
#		for sam in ${{samples[@]}} \
#		do \
#		if [ ! -d {params.results}$sam ] \
#		then \
#		mkdir {params.results}$sam \
#		fi \
#		files=({input.datadir}$sam/*) \
#		if [ ${{#files[@]}} -gt 1 ] \
#		then \
#		for f in ${{files[@]}} \
#		do \
#		base=$(basename $f .sra) \
#		fastq-dump --outdir {params.results}$sam/ {input.datadir}$sam/$base.sra 2> {log} \
#		done \
#		files=({params.results}$sam/*) \
#		cat ${{files[@]}} > {params.results}$sam/$sam.fastq \
#		rm ${{files[@]}} \
#		else \
#		base=$(basename ${{files[0]}} .sra) \
#		fastq-dump --outdir {params.results}$sam {input.datadir}$sam/$base.sra  2> {log} \
#		mv  {params.results}$sam/$base.fastq {params.results}$sam/$sam.fastq \
#		fi \
#		done \

#### This is working in commandline

#data="/home/rioualen/Desktop/workspace/fg-chip-seq/data2/Scerevisiae-Pho4/"
#results="/home/rioualen/Desktop/workspace/fg-chip-seq/results3/"
#samples=( "GSM730517" "GSM730528" )


#for sam in ${samples[@]}
#do
#	mkdir -p $results$sam
#	echo -e "Reading $sam directory $data$sam... \n"
#	files=($data$sam/*)
#	if [ ${#files[@]} -gt 1 ]
#	then
#		echo -e " \n \nCase 2+ files : ${files[@]} \n"
#		for f in ${files[@]}
#		do
#			base=$(basename $f .sra)
#			echo -e "$base \n"
#			echo -e " \tConverting $base.sra to $base.fastq... \n"
##			fastq-dump --outdir $results$sam/ $data$sam/$base.sra
#		done
#		echo -e " \tMerging ${#files[@]} together as $sam.fastq. \n"
#		echo -e " \tCmd: cat ${files[@]} > $data$sam.fastq"
#		files=($results$sam/*)
#		cat ${files[@]} > $results$sam/$sam.fastq
#		rm ${files[@]}
#	else
#		echo -e " \n \nCase 1 file : ${files[@]} \n"
#		base=$(basename ${files[0]} .sra)
#		echo -e " \tConverting $base.sra to $base.fastq... \n"
##		fastq-dump --outdir $results$sam $data$sam/$base.sra
#		echo -e " \tMoving $data$base.fastq to $results$sam/$sam.fastq \n"
#		mv  $results$sam/$base.fastq $results$sam/$sam.fastq
#	fi
#done


### Testing different syntax

#for d in GSM730517 GSM730528;
#do p=results3/$d; 
#  mkdir -p $p;
#  for f in $p/*; 
#  do echo $f; 
#  done;
#done;


#data="data2/Scerevisiae-Pho4/"
#results="results3/"
#samples=( "GSM730517" "GSM730528" )
#for sam in ${samples[@]}
#do p=results3/$d;
#mkdir -p $p;
#for f in $p/*;
#do
#echo $f;
#done
#done
#if [ ! -d $results$sam ]
#then
#mkdir $results$sam
#fi
#echo -e "Reading $sam directory $data$sam... \n"
#files=$data$sam/*
#echo -e "\n\n\n${files[@]}\n\n\n"
#echo -e "\n\n\n${files[0]}\n\n\n"
#echo -e "\n\n\n${files[1]}\n\n\n"
#if [ ${#files[@]} -gt 1 ]
#then
#echo -e " \n \nCase 2+ files : ${files[@]} \n"
#for f in ${files[@]}
#do
#base=$(basename $f .sra)
#echo -e "$base \n"
#echo -e " \tConverting $base.sra to $base.fastq... \n"
#fastq-dump --outdir $results$sam/ $data$sam/$base.sra
#done
#echo -e " \tMerging ${#files[@]} together as $sam.fastq. \n"
#echo -e " \tCmd: cat ${files[@]} > $data$sam.fastq"
#files=($results$sam/*)
#cat ${files[@]} > $results$sam/$sam.fastq
#rm ${files[@]}
#else
#echo -e " \n \nCase 1 file : ${files[@]} \n"
#base=$(basename ${files[0]} .sra)
#echo -e " \tConverting $base.sra to $base.fastq... \n"
#fastq-dump --outdir $results$sam $data$sam/$base.sra
#echo -e " \tMoving $data$base.fastq to $results$sam/$sam.fastq \n"
#mv  $results$sam/$base.fastq $results$sam/$sam.fastq
#fi
#done





#data="/some/absolute/path/to/data/"
#results="/absolute/path/to/outputdir/"
#samples=( "GSM730517" "GSM730528" )
#if [ ! -d $results ]
#	then
#	mkdir $results
#fi
#for sam in ${samples[@]}
#do
#	if [ ! -d $results$sam ]
#	then
#		ir $results$sam
#	fi
#	echo -e "Reading $sam directory $data$sam... \n"
#	files=($data$sam/*)
#	if [ ${#files[@]} -gt 1 ]
#	then
#		echo -e " \n \nCase 2+ files : ${files[@]} \n"
#		for f in ${files[@]}
#		do
#			base=$(basename $f .sra)
#			echo -e " \tConverting $base.sra to $base.fastq... \n"
#			fastq-dump --outdir $results$sam/ $data$sam/$base.sra
#		done
#		echo -e " \tMerging ${#files[@]} together as $sam.fastq. \n"
#		echo -e " \tCmd: cat ${files[@]} > $data$sam.fastq"
#		files=($results$sam/*)
#		cat ${files[@]} > $results$sam/$sam.fastq
#		rm ${files[@]}
#	else
#		echo -e " \n \nCase 1 file : ${files[@]} \n"
#		base=$(basename ${files[0]} .sra)
#		echo -e " \tConverting $base.sra to $base.fastq... \n"
#		fastq-dump --outdir $results$sam $data$sam/$base.sra
#		echo -e " \tMoving $data$base.fastq to $results$sam/$sam.fastq \n"
#		mv  $results$sam/$base.fastq $results$sam/$sam.fastq
#	fi
#done


