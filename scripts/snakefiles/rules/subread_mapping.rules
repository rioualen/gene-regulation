"""Align each sample with the R-package subread.

   To align each sample on the reference genome the R-package subread
   first needs to build a index with the function builindex(). The
   alignment is then executed with the function align(), which calls
   the tool read mapping tool Subread.  

   Reference: Liao Y, Smyth GK and Shi W (2013). The Subread aligner:
   fast, accurate and scalable read mapping by seed-and-vote.  Nucleic
   Acids Research, 41(10):e108

"""
rule buildindex_mapping:
	"""Build an index of the genome, which is required before alignig the
reads.
"""
	input: reference_genome = config["subread"]["reference_genome"]
	output: config["dir"]["results"] + "control_buildindex.txt"
	params: reference_index = config["dir"]["results"] + config["subread"]["basename"], \
            qsub = config["qsub"] + " -e " + config["dir"]["results"] + "buildindex_qsub.err " \
                   + " -o " + config["dir"]["results"] + "buildindex_qsub.out"
	log: config["dir"]["results"] + "buildindex.log"
	benchmark: config["dir"]["results"] + "buildindex_benchmark.json"
	run: 
		R("""
library("Rsubread")
buildindex(basename="{params.reference_index}",reference="{input.reference_genome}")
write("buildindex ok", file="{output}")
""")

rule subread_mapping: 
     """Align reads onto a reference genome with the
	tool subread-align.

        Before running the alignment, an index of the genome sequence
        has to be built with the tool Rsubread::buildindex.
"""
	input: file_input = "{data_dir}/{dataset}_{trimmed}.fastq", control_txt = config["dir"]["results"] + "control_buildindex.txt"
	output: "{data_dir}/{dataset}_{trimmed}_{aligner}.bam"
	params: reference_index = config["dir"]["results"] + config["subread"]["basename"], \
            qsub = config["qsub"] + "  -e {data_dir}/{dataset}_{trimmed}_{aligner}_subread_mapping_qsub.err " \
                + " -o {data_dir}/{dataset}_{trimmed}_{aligner}_subread_mapping_qsub.out"
	log: "{data_dir}/{dataset}_{trimmed}_{aligner}_subread_mapping.log"
	benchmark: "{data_dir}/{dataset}_{trimmed}_{aligner}_subread_mapping_benchmark.json"
	run: 
		R(""" 
			library("Rsubread")
			align(index="{params.reference_index}",readfile1="{input.file_input}",output_file="{output}")
		""")
